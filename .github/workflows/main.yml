name: CI/CD

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:
    inputs:
      rules_file:
        description: 'Path to rules file'
        required: false
        default: 'deploy/rules.json'
      deploy_env:
        description: 'Deployment environment'
        required: false
        default: 'production'
        type: choice
        options:
          - production
          - preview

env:
  PYTHON_VERSION: "3.13"
  NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
  NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}

jobs:
  test:
    runs-on: ubuntu-latest
    outputs:
      should-deploy: ${{ steps.check-deploy.outputs.should-deploy }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: latest
          virtualenvs-create: true
          virtualenvs-in-project: true

      - name: Install dependencies
        run: poetry install

      - name: Run quality checks
        run: poetry run poe quality

      - name: Run tests with coverage
        run: poetry run poe test-cov

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.xml
          fail_ci_if_error: false

      - name: Test example rules
        run: |
          echo "ðŸ” Testing examples/rules.json"
          poetry run poe check
          poetry run poe build

      - name: Test deploy rules
        run: |
          echo "ðŸ” Testing deploy/rules.json"
          poetry run poe check-rules deploy/rules.json
          poetry run poe build-rules deploy/rules.json --outdir deploy-output

      - name: Verify outputs
        run: |
          echo "ðŸ“¦ Generated files:"
          ls -la output/ deploy-output/
          echo ""
          echo "ðŸ“„ Example _redirects:"
          cat output/_redirects
          echo ""
          echo "ðŸ“„ Deploy _redirects:"
          cat deploy-output/_redirects

      - name: Check if should deploy
        id: check-deploy
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]] || [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "should-deploy=true" >> $GITHUB_OUTPUT
          else
            echo "should-deploy=false" >> $GITHUB_OUTPUT
          fi


  # Deploy to Netlify (uses CLI from Poetry, not the built package)
  deploy-netlify:
    runs-on: ubuntu-latest
    needs: test
    if: needs.test.outputs.should-deploy == 'true'
    environment:
      name: ${{ github.event.inputs.deploy_env || (github.event_name == 'pull_request' && 'preview' || 'production') }}
      url: ${{ steps.deploy.outputs.deploy-url }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: latest
          virtualenvs-create: true
          virtualenvs-in-project: true

      - name: Install Bridge URL
        run: poetry install

      - name: Check for rules file
        id: check-rules
        run: |
          RULES_FILE="${{ github.event.inputs.rules_file || 'deploy/rules.json' }}"
          if [ -f "$RULES_FILE" ]; then
            echo "rules-exist=true" >> $GITHUB_OUTPUT
            echo "âœ… Found rules file: $RULES_FILE"
          else
            echo "rules-exist=false" >> $GITHUB_OUTPUT
            echo "âŒ Rules file not found: $RULES_FILE"
            echo "Creating default rules file..."
            mkdir -p deploy
            cp examples/rules.json deploy/rules.json
            echo "âœ… Created default rules file: deploy/rules.json"
            echo "rules-exist=true" >> $GITHUB_OUTPUT
          fi

      - name: Validate rules
        run: |
          RULES_FILE="${{ github.event.inputs.rules_file || 'deploy/rules.json' }}"
          echo "ðŸ” Validating rules file: $RULES_FILE"
          poetry run poe check-rules "$RULES_FILE"

      - name: Generate Netlify artifacts
        run: |
          RULES_FILE="${{ github.event.inputs.rules_file || 'deploy/rules.json' }}"
          echo "ðŸ—ï¸ Building Netlify artifacts from: $RULES_FILE"
          poetry run poe build-rules "$RULES_FILE" --outdir netlify-dist

      - name: List generated files
        run: |
          echo "ðŸ“¦ Generated files:"
          ls -la netlify-dist/
          echo ""
          echo "ðŸ“„ _redirects content:"
          cat netlify-dist/_redirects
          echo ""
          echo "ðŸ“„ netlify.toml content:"
          cat netlify-dist/netlify.toml

      - name: Create minimal site
        run: |
          mkdir -p site
          # Create a simple index.html that shows the redirects are working
          cat > site/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
              <title>Bridge URL - Redirects Active</title>
              <meta charset="utf-8">
              <meta name="viewport" content="width=device-width, initial-scale=1">
              <style>
                  body { font-family: Arial, sans-serif; max-width: 800px; margin: 50px auto; padding: 20px; }
                  .status { background: #d4edda; border: 1px solid #c3e6cb; padding: 15px; border-radius: 5px; }
                  pre { background: #f8f9fa; padding: 15px; border-radius: 5px; overflow-x: auto; }
                  .timestamp { color: #6c757d; font-size: 0.9em; }
              </style>
          </head>
          <body>
              <h1>ðŸŒ‰ Bridge URL</h1>
              <div class="status">
                  <h2>âœ… Redirects are active!</h2>
                  <p>This site is configured with URL redirections generated by Bridge URL.</p>
                  <p class="timestamp">Deployed: $(date -u)</p>
              </div>

              <h3>Configuration Files</h3>
              <p>The following redirect rules are currently active:</p>

              <h4>_redirects</h4>
              <pre>$(cat netlify-dist/_redirects)</pre>

              <h4>netlify.toml</h4>
              <pre>$(cat netlify-dist/netlify.toml)</pre>

              <hr>
              <p><a href="https://github.com/arkady/bridge-url">Bridge URL on GitHub</a></p>
          </body>
          </html>
          EOF

          # Copy Netlify config files
          cp netlify-dist/_redirects site/
          cp netlify-dist/netlify.toml site/

      - name: Install Netlify CLI
        run: npm install -g netlify-cli

      - name: Deploy to Netlify
        id: deploy
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            # Production deployment
            DEPLOY_URL=$(netlify deploy --dir=site --prod --message="Deploy from GitHub Actions - ${{ github.sha }}" --json | jq -r '.url')
          else
            # Preview deployment
            DEPLOY_URL=$(netlify deploy --dir=site --message="Preview from GitHub Actions - ${{ github.sha }}" --json | jq -r '.deploy_url')
          fi
          echo "deploy-url=$DEPLOY_URL" >> $GITHUB_OUTPUT
          echo "ðŸš€ Deployed to: $DEPLOY_URL"
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}

      - name: Comment deployment status
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ðŸŒ‰ **Bridge URL Deployment**

            âœ… **Deploy Preview**: ${{ steps.deploy.outputs.deploy-url }}

            ðŸ“‹ **Rules validated and deployed successfully!**

            Generated artifacts:
            - \`_redirects\` file
            - \`netlify.toml\` configuration

            ðŸ”— [View deployment logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})`
            })
